<!DOCTYPE html>
<html lang="en">
  <body>
    <main id="main" class="main">
      <link href="/assets/css/dash_workload.css" rel="stylesheet" />
      <section id="dynimic_app" class="section dashboard">
        <div class="row">
          <!-- Left side columns -->
          <div class="col-lg-8">
            <div class="row">
              <!-- Workload Card -->
              <div class="col-xxl-4 col-md-6">
                <div class="card info-card sales-card">
                  <div class="card-body">
                    <h5 class="card-title">Workload<span></span></h5>

                    <div class="d-flex align-items-center">
                      <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                        <!-- <i class="bi bi-cart"></i> -->
                        <img src="/assets/img/workload.png" class="bi"></img>
                      </div>
                      <div class="ps-3">
                        <h6>{{totalWorkloads}}</h6>
                        <span class="text-success small pt-1 fw-bold">{{ totalPods}}</span> <span class="text-muted small pt-2 ps-1">pods</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- End Workload Card -->

              <!-- Cluster Card -->
              <div class="col-xxl-4 col-md-6">
                <div class="card info-card revenue-card">
                  <div class="card-body">
                    <h5 class="card-title">Cluster</h5>

                    <div class="d-flex align-items-center">
                      <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                        <!-- <i class="bi bi-currency-dollar"></i> -->
                        <img src="/assets/img/cluster.png" class="bi"></img>
                      </div>
                      <div class="ps-3">
                        <h6>{{totalClusters}}</h6>
                        <span class="text-success small pt-1 fw-bold">{{totalNodes}}</span>
                        <span class="text-muted small pt-2 ps-1"> total nodes</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- End Cluster Card -->

              <!-- Issued Card -->
              <div class="col-xxl-4 col-xl-12">
                <div class="card info-card customers-card">
                  <div class="card-body">
                    <h5 class="card-title">Issued</h5>

                    <div class="d-flex align-items-center">
                      <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                        <i class="bx bxs-error-alt"></i>
                      </div>
                      <div class="ps-3">
                        <h6></h6>
                        <span class="text-danger small pt-1 fw-bold">0</span> <span class="text-muted small pt-2 ps-1">current request</span><br />
                        <span class="text-danger small pt-1 fw-bold">2</span> <span class="text-muted small pt-2 ps-1">scaling pods</span><br />
                        <span class="text-danger small pt-1 fw-bold">2</span> <span class="text-muted small pt-2 ps-1">scaling nodes</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- End Issued Card -->

              <!-- í´ëŸ¬ìŠ¤í„° ìƒíƒœ -->
              <div class="col-12">
                <div class="card">
                  <div id="dashboard">
                    <div v-for="cluster in clusters" :key="cluster.id" class="cluster-container">
                      <dashboard-cluster-nodes
                        :cluster="cluster"
                        :cluster-stat="clusterStats[cluster.id] || {}"
                        :cluster-color="clusterColorMap[cluster.id] || {}"></dashboard-cluster-nodes>
                    </div>
                  </div>
                  <div id="dashboard-tooltip" class="dashboard-tooltip"></div>
                </div>
              </div>
              <!-- í´ëŸ¬ìŠ¤í„° ìƒíƒœ -->
            </div>
          </div>
          <!-- End Left side columns -->

          <!-- Right side columns -->
          <div class="col-lg-4">
            <!-- Workload Chart -->
            <div class="card">
              <div class="card-body pb-0">
                <h5 class="card-title">Workload by Cluster</h5>
                <workload-chart :cluster-stats="clusterStats || {}"></workload-chart>
              </div>
            </div>
            <!-- Workload Chart -->

            <!-- Recent Activity -->
            <div class="card">
              <div class="card-body">
                  <h5 class="card-title"><!-- <img src="/assets/img/new32.png" class="pe-1"> --></img>Recent Activity</h5>
                  <recent-activity></recent-activity>
              </div>
            </div><!-- End Recent Activity -->

          </div>
          <!-- End Right side columns -->
        </div>
      </section>

      <script>
        {
          window.page_clear = function () {
            //ë©”ì¸ì—ì„œ ë™ì  htmlí˜¸ì¶œí•˜ê¸° ì „ì— ê¸°ì¡´ í•¨ìˆ˜ í´ë¦¬ì–´í•˜ê¸° ìœ„í•¨, ë‹¤ë¥¸ í´ë¦¬ì–´ í•¨ìˆ˜ ìˆìœ¼ë©´ ì—¬ê¸°ì— ê¸°ë¡
            const ele = document.getElementById("dynimic_app");
            if (ele) {
              const existingApp = ele.__vue_app__;
              if (existingApp) {
                existingApp.unmount(); // ì–¸ë§ˆìš´íŠ¸
                ele.innerHTML = ""; // ê¸°ì¡´ DOM í´ë¦¬ì–´
              }
            }
          };

          // í´ëŸ¬ìŠ¤í„° ë…¸ë“œì™€ í—¤ë”ë¥¼ í†µí•©í•œ ì»´í¬ë„ŒíŠ¸
          const DashboardClusterNodes = {
            template: `
              <!-- í´ëŸ¬ìŠ¤í„° í—¤ë” -->
              <div class="cluster-header">
                <div class="cluster-name">{{ cluster.name }}</div>
                <div class="cluster-stats">
                  ì›Œí¬ë¡œë“œ: {{ clusterStat?.workloads || 0 }}<br>
                  íŒŒë“œ: {{ clusterStat?.pods || 0 }}
                </div>
              </div>

              <!-- í´ëŸ¬ìŠ¤í„° ë…¸ë“œ -->
              <div class="node-container">
                <div v-for="node in cluster.nodes" :key="node.name" class="node">
                  <div class="node-name">{{ node.name }}</div>
                  <div class="node-bar">
                    <div
                      v-for="pod in node.pods"
                      :key="pod.podUid"
                      class="pod"
                      :style="{ backgroundColor: clusterColor?.[pod.mlId] || '#ccc' }"
                      @mouseover="showTooltip($event, pod)"
                      @mouseout="hideTooltip"
                    >
                    <!-- Pending: íŒŒë“œê°€ ìƒì„±ë˜ì—ˆìœ¼ë‚˜, ì•„ì§ ëª¨ë“  ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ì§€ ì•Šì€ ìƒíƒœ.
                          Running: ëª¨ë“  ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì´ê±°ë‚˜, ìµœì†Œ í•˜ë‚˜ê°€ ì‹¤í–‰ ì¤‘ì¸ ìƒíƒœ.
                          Succeeded: ëª¨ë“  ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì¢…ë£Œëœ ìƒíƒœ.
                          Failed: í•˜ë‚˜ ì´ìƒì˜ ì»¨í…Œì´ë„ˆê°€ ë¹„ì •ìƒì ìœ¼ë¡œ ì¢…ë£Œëœ ìƒíƒœ.
                          Unknown: ìƒíƒœë¥¼ ì•Œ ìˆ˜ ì—†ìŒ (ì£¼ë¡œ í†µì‹  ë¬¸ì œë¡œ ë°œìƒ).
                    -->
                      <span class="status-icon">
                        {{ pod.statusPhase === 'RUNNING' ? 'âœ”ï¸' : 
                          pod.statusPhase === 'PENDING' ? 'â³' : 
                          pod.statusPhase === 'SUCCEEDED' ? 'ğŸ†' : 
                          pod.statusPhase === 'FAILED' ? 'âŒ' : 
                          pod.statusPhase === 'UNKNOWN' ? 'â“' : '' }}
<!--
                          {{ pod.statusPhase === 'RUNNING' ? 'âœ…' : 
                            pod.statusPhase === 'PENDING' ? 'ğŸ•’' : 
                            pod.statusPhase === 'SUCCEEDED' ? 'ğŸ' : 
                            pod.statusPhase === 'FAILED' ? 'ğŸ’¥' : 
                            pod.statusPhase === 'UNKNOWN' ? 'ğŸ¤·' : '' }} -->

                      </span>
                    </div>
                  </div>
                </div>
              </div>
          `,
            props: {
              cluster: {
                type: Object,
                required: true, // ë¶€ëª¨ì—ì„œ ë°˜ë“œì‹œ ì „ë‹¬í•´ì•¼ í•˜ëŠ” í•„ìˆ˜ ê°’
              },
              clusterStat: {
                type: Object,
                required: true, // ë¶€ëª¨ì—ì„œ ë°˜ë“œì‹œ ì „ë‹¬í•´ì•¼ í•˜ëŠ” í•„ìˆ˜ ê°’
              },
              clusterColor: {
                type: Object,
                required: true, // ë¶€ëª¨ì—ì„œ ë°˜ë“œì‹œ ì „ë‹¬í•´ì•¼ í•˜ëŠ” í•„ìˆ˜ ê°’
              },
            },
            methods: {
              showTooltip(event, pod) {
                this.hideTooltip();
                const tooltip = document.getElementById("dashboard-tooltip");

                tooltip.innerHTML = `
                <strong>ì›Œí¬ë¡œë“œ : </strong> ${pod.mlId}<br>
                <strong>íŒŒë“œ : </strong> ${pod.pod}<br>
                <strong>ìƒíƒœ : </strong> ${pod.statusPhase}<br>
                <strong>ì‹œì‘ ì‹œê°„ : </strong> ${new Date(pod.createdTimestamp).toLocaleString()}<br>
                <!-- <strong>ì˜ˆìƒ ì‹œì‘ ì‹œê°„ : </strong> ${new Date(pod.expected_start_time).toLocaleString()}<br>
                <strong>ì˜ˆìƒ ì¢…ë£Œ ì‹œê°„ : </strong> ${new Date(pod.expected_end_time).toLocaleString()}<br> -->
                <strong>ì¢…ë£Œ ì‹œê°„ : </strong> ${pod.completedTimestamp ? new Date(pod.completedTimestamp).toLocaleString() : "N/A"}
              `;
                document.body.appendChild(tooltip);

                tooltip.style.left = event.pageX - window.scrollX + 20 + "px"; // ë§ˆìš°ìŠ¤ ìœ„ì¹˜ì— íˆ´íŒ ìœ„ì¹˜ ì§€ì •
                tooltip.style.top = event.pageY - window.scrollY + 20 + "px";
                tooltip.style.display = "block";
              },
              hideTooltip() {
                const tooltip = document.getElementById("dashboard-tooltip");
                tooltip.style.display = "none"; // íˆ´íŒ ìˆ¨ê¸°ê¸°
              },
            },
          };

          // WorkloadChart ì»´í¬ë„ŒíŠ¸ (ECharts ì°¨íŠ¸ë¥¼ í‘œì‹œ)
          const WorkloadChart = {
            template: `<div ref="chart" style="min-height: 400px;" class="echart"></div>`,
            data() {
              return {
                chart: null,
              };
            },
            props: {
              clusterStats: {
                type: Object,
                required: true, // ë¶€ëª¨ì—ì„œ ë°˜ë“œì‹œ ì „ë‹¬í•´ì•¼ í•˜ëŠ” í•„ìˆ˜ ê°’
              },
            },
            mounted() {
              this.initChart();

              // EventBusì—ì„œ ë°ì´í„° ìˆ˜ì‹ 
              //EventBus.on('clusterWorkloadStatic', this.updateChart);
            },
            unmounted() {
              // ì»´í¬ë„ŒíŠ¸ê°€ ì‚¬ë¼ì§ˆ ë•Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
              //EventBus.off('clusterWorkloadStatic', this.updateChart);

              // ECharts ì¸ìŠ¤í„´ìŠ¤ ì œê±°
              if (this.chart) {
                this.chart.dispose(); // ì°¨íŠ¸ ë©”ëª¨ë¦¬ í•´ì œ
              }
            },
            watch: {
              // clusterStatsê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì°¨íŠ¸ë¥¼ ì—…ë°ì´íŠ¸
              clusterStats: {
                handler(newStats) {
                  this.updateChart(newStats);
                },
                deep: true, // nested ì†ì„±ê¹Œì§€ ê°ì§€í•˜ë ¤ë©´ deep ì˜µì…˜ì„ ì‚¬ìš©
              },
            },
            methods: {
              initChart() {
                // ECharts ì°¨íŠ¸ ì´ˆê¸°í™”
                this.chart = echarts.init(this.$refs.chart);
                this.chart.setOption({
                  tooltip: {
                    trigger: "item",
                  },
                  legend: {
                    top: "5%",
                    left: "center",
                  },
                  series: [
                    {
                      name: "ì›Œí¬ë¡œë“œ ê°¯ìˆ˜",
                      type: "pie",
                      radius: ["40%", "70%"],
                      avoidLabelOverlap: false,
                      label: {
                        show: false,
                        position: "center",
                      },
                      emphasis: {
                        label: {
                          show: true,
                          fontSize: "18",
                          fontWeight: "bold",
                        },
                      },
                      labelLine: {
                        show: false,
                      },
                      data: [],
                    },
                  ],
                });
              },
              updateChart(data) {
                // EventBusë¡œ ë°›ì€ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì°¨íŠ¸ë¥¼ ì—…ë°ì´íŠ¸
                const chartData = Object.values(data).map((item) => ({
                  value: item.workloads,
                  name: item.name,
                }));
                
                this.chart.setOption({
                  series: [
                    {
                      data: chartData,
                    },
                  ],
                });
              },
            },
          };

          // Recent Activity ì»´í¬ë„ŒíŠ¸
         const RecentActivity = {
            template: `
                <div class="activity" style="overflow-y: auto;" :style="{ height: containerHeight }">
                    <div v-for="(activity, index) in activities" :key="activity.id" class="activity-item d-flex">
                        <div class="activite-label">{{ formatTime(activity.regDt) }}</div>
                        <i class="bi bi-circle-fill activity-badge" :class="activityBadgeClass(activity)"></i>
                        <div class="activity-content">{{ activity.description }}</div>
                    </div>
                </div>
            `,
            data() {
                return {
                    activities: [],  // í™œë™ ëª©ë¡
                    lastActivityId: null,  // ë§ˆì§€ë§‰ í™œë™ ID (ìƒˆë¡œìš´ ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´)
                    containerHeight: '400px',  // ì»¨í…Œì´ë„ˆ ë†’ì´ (ê¸°ë³¸ê°’)
                    intervalId: null,   // setInterval ìƒì„± ê°ì²´, ì œê±°í•˜ê¸° ìœ„í•¨
                    processUrlPath: "/proxy/interface/common/events",
                };
            },
            mounted() {
                this.fetchActivities();  // ì»´í¬ë„ŒíŠ¸ê°€ ë§ˆìš´íŠ¸ë  ë•Œ í™œë™ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                this.intervalId = setInterval(this.fetchActivities, 10000);  // 1ì´ˆë§ˆë‹¤ ìµœì‹  í™œë™ ë°ì´í„° ë°›ì•„ì˜¤ê¸°

                this.updateContainerHeight();  // í™”ë©´ í¬ê¸°ì— ë§ê²Œ ì»¨í…Œì´ë„ˆ ë†’ì´ ì„¤ì •
                window.addEventListener('resize', this.updateContainerHeight);  // í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ ì»¨í…Œì´ë„ˆ ë†’ì´ ì—…ë°ì´íŠ¸
            },
            unmounted() {
              clearInterval(this.intervalId); // íƒ€ì´ë¨¸ ì •ë¦¬
            },
            methods: {
                updateContainerHeight() {
                    const windowHeight = window.innerHeight;  // í˜„ì¬ ì°½ ë†’ì´
                    const scrollY = window.scrollY;          // í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜

                    // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ê°€ ìˆì„ ê²½ìš°, ìŠ¤í¬ë¡¤ ìœ„ì¹˜ë¥¼ ê³ ë ¤í•˜ì—¬ ì»¨í…Œì´ë„ˆ ë†’ì´ ì„¤ì •
                    const containerHeight = `${windowHeight - 200 - scrollY}px`;  // ì—¬ë°±ê³¼ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë°˜ì˜

                    this.containerHeight = containerHeight;
                },
                fetchActivities() {
                  const url = this.lastActivityId 
                          ? `${this.processUrlPath}/${this.lastActivityId}` 
                           : this.processUrlPath;

                  axios.get(url)
                      .then((response) => {
                        const newActivities = response.data;

                        console.log('newActivities', newActivities);
                        if (newActivities.length) {
                             this.activities = [...newActivities, ...this.activities].slice(0, 100);
                             this.lastActivityId = newActivities[0]?.id || this.lastActivityId;  // ê°€ì¥ ìµœì‹  ë©”ì‹œì§€ ID ì—…ë°ì´íŠ¸
                         }
                        

                      })
                      .catch(() => {
                        //alert("");
                        showNotification("ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.!", "danger"); // ì„±ê³µ ì•Œë¦¼ main.js
                      });
                },
                formatTime(timestamp) {
                    const now = new Date();
                    const activityTime = new Date(timestamp);
                    const diff = now - activityTime;

                    const minutes = Math.floor(diff / 60000);
                    const hours = Math.floor(diff / 3600000);
                    const days = Math.floor(diff / 86400000);

                    if (days > 0) return `${days}ì¼ ì „`;
                    if (hours > 0) return `${hours}ì‹œê°„ ì „`;
                    return `${minutes}ë¶„ ì „`;
                },
                activityBadgeClass(activity) {
                  return 'success' ;
                    //return activity.type === 'success' ? 'text-success' : 'text-danger';
                }
            }
        };

          // Vue ì• í”Œë¦¬ì¼€ì´ì…˜
          const app = Vue.createApp({
            components: { DashboardClusterNodes, WorkloadChart, RecentActivity},
            data() {
              return {
                clusters: [], //array
                clusterStats: {}, // object[object]
                clusterColorMap: {}, // object[object]
                previousClusters: [], // ì´ì „ ìƒíƒœ ì €ì¥
                predefinedColors: [],
                processUrlPath: '/dashboard',
                //processUrlPath: 'dashboard_workload.json',
                intervalId: null, // íƒ€ì´ë¨¸ IDë¥¼ ì €ì¥í•  ë³€ìˆ˜
              };
            },
            computed: {
              totalClusters() {
                return this.clusters.length;
              },
              totalNodes() {
                return this.clusters.reduce((sum, cluster) => sum + (cluster.nodes?.length || 0), 0);
              },
              totalWorkloads() {
                return Object.values(this.clusterStats).reduce((sum, stats) => sum + (stats.workloads || 0), 0);
              },
              totalPods() {
                return this.clusters.reduce((total, cluster) => {
                  return total + cluster.nodes.reduce((nodeSum, node) => nodeSum + (node.pods?.length || 0), 0);
                }, 0);
              },
            },
            methods: {
              // ì„œë²„ì—ì„œ ì´ˆê¸°ê°’ ê°€ì ¸ì˜¤ê¸°
              fetchInitialData() {
                axios
                  .get(this.processUrlPath) // ìƒ˜í”Œ JSON ê²½ë¡œ
                  .then((response) => {
                    if (response.data) {
                      const responseData = response.data;
                      const clustersData = responseData.clusters;
                      const podsData     = responseData.pods;

                      const parsedPodList = podsData.map((item) => {
                        item.pods = item.pods ? JSON.parse(item.pods) : [];
                        return item;
                      });

                      const parsedClusterList = clustersData.map((item) => {
                        item.nodes = item.nodes ? JSON.parse(item.nodes) : [];
                        item.nodes.map((node) =>{
                          const matchingPod = parsedPodList.find(pod => pod.clUid == item.clUid && pod.node == node.name);
                          if(matchingPod){
                            node.pods = matchingPod.pods.pods;
                            node.pods.sort((a, b) => new Date(b.createdTimestamp) - new Date(a.createdTimestamp));
                          }else node.pods = [];

                          return node;
                        });

                        return item;
                      });

                      //console.log('parsedClusterList', parsedClusterList);
                      //console.log('parsedPodList', parsedPodList);

                      //ë¶ˆí•„ìš”í•œ í‚¤ ì‚­ì œ
                      parsedClusterList.forEach((item) =>{
                        delete item.node;
                        delete item.pods;
                      });

                      //í‚¤ ì´ë¦„ ë³€ê²½ clUid->id cluster->name
                      const requestData = parsedClusterList.map(({ clUid, cluster, ...rest }) => ({
                          ...rest, id: clUid, name: cluster
                      }));

                      //console.log(requestData);

                      this.updateClusters(requestData);
                    }
                  })
                  .catch((error) => {
                    console.error("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", error);
                  });
              },
              async fetchPredefinedColors() {
                try {
                  const response = await fetch("options.json");
                  const data = await response.json();
                  this.predefinedColors = data.predefinedColors || [];
                } catch (error) {
                  console.error("ìƒ‰ìƒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                }
              },
              processClusterData() { //ìƒíƒœì •ë³´ ì €ì¥
                this.clusters.forEach((cluster) => {
                  const stats = { name: cluster.name, workloads: 0, pods: 0 };
                  const workloadIds = new Set();
                  const workloadColorMap = {};

                  cluster.nodes.forEach((node) => {
                    node.pods.forEach((pod) => {
                      stats.pods++;
                      workloadIds.add(pod.mlId);

                      if (!workloadColorMap[pod.mlId]) {
                        workloadColorMap[pod.mlId] = this.getIndexedColor(workloadIds.size - 1);
                      }
                    });
                  });

                  stats.workloads = workloadIds.size;
                  this.clusterStats[cluster.id] = stats;
                  this.clusterColorMap[cluster.id] = workloadColorMap;
                });

                //EventBus.emit("clusterWorkloadStatic", this.clusterStats);
              },
              updateClusters(newData) {
                const updatedClusters = [];
                newData.forEach((newCluster) => {
                  const existingCluster = this.previousClusters.find((c) => c.id === newCluster.id);
                  if (existingCluster) {
                    updatedClusters.push(newCluster);
                  } else {
                    updatedClusters.push(newCluster);
                  }
                });

                this.previousClusters = updatedClusters;
                this.clusters = updatedClusters;
                this.processClusterData();
              },
              getIndexedColor(index) {
                if (index >= this.predefinedColors.length) {
                  return `#${Math.floor(Math.random() * 16777215).toString(16)}`;
                }
                return this.predefinedColors[index];
              },
            },
            async mounted() {
              await this.fetchPredefinedColors();
              //await this.fetchClusterData();
              this.fetchInitialData();

              this.intervalId = setInterval(() => {
                  this.fetchInitialData(); // 5ì´ˆë§ˆë‹¤ ë°ì´í„° ì—…ë°ì´íŠ¸
              }, 5000);
            },
            unmounted() {
              if (this.intervalId !== null) {
                clearInterval(this.intervalId);
              }
            },
          });
          app.mount("#dynimic_app");
        }
        //# sourceURL=dashboardJS
      </script>
    </main>
    <!-- End #main -->
  </body>
</html>
